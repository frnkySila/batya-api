# Описание Web API сервера Batya IM

## 1. Введение

### 1.1. Входящий формат сообщения в JSON

Многие из запросов протокола возвращают помимо прочего сообщения, отправленные кому-то там или там хуй пойми короче. Во всех случаях JSON-объект сообщения имеет один и тот же формат:

```
{
    guid: [guid],
    [dialog_id: [dialog_id],]
    [sender: [sender]],
    timestamp: [timestamp],
    type: [type],
    content: [content]
}
```

* *guid*: глобальный идентификатор сообщения. Применяется для избежания дублей в чате при повторном получении сообщения;
* *dialog_id* (опциональное поле): при наличии означает, что сообщение было отправлено в конференцию с данным `dialog_id`. Используется только в запросах, где таковое не указано в параметрах запроса;
* *sender* (опциональное поле): `username` отправителя. Используется только в запросах, где таковое не указано в параметрах запроса;
* *timestamp*: UNIX timestamp, обозначающий момент, когда сообщение пришло на сервер;
* *type*: тип сообщения (поддерживаемые типы см. ниже);
* *content*: содержание сообщение (кодировка в зависимости от типа)

|type|content
|---|---|
|text|Текст сообщения в UTF-8
|image|*зарезервировано*
|audio|*зарезервировано*
|video|*зарезервировано*
|sticker|*зарезервировано*

Прим.: типы сообщений кроме `text` будут имплементированы в будущих версиях протокола если вы хотя бы это сделаете.

### 1.2. Идентификатор диалога

Идентификатор диалога представляет собой либо имя пользователя, либо идентификатор конференции. Для того, чтобы разделить эти два пространства имен, инентификатор конференции предваряется символом плюса, а в имени пользователя этот символ запрещен:

|Поле|Формат
|---|---|
|username | `[A-Za-z0-9_-]+`
|conference_id | `\+[A-Za-z0-9]+`
|dialog_id | `conference_id | username`

## 2. Список запросов

### 2.1. Авторизация пользователя

* **Method/URL:** `POST /login`

*  **URL Params:** *none*

* **Data Params**

  ```
  {
    username: [username],
    password: [password]
  }
  ```
  *password️*: plain text password

* **Success Response:**
  
  * **Code:** `200 Ok`
  * **Content:** `{ token: [token] }`

  *token*: аутентификационный токен пользователя
   
* **Error Response:**

  * **Code:** `403 Forbidden`
  * **Content:** `{ error : "Invalid username or password" }`

* **Sample Call:**

  *TODO: добавить пример на js*
  


### 2.2. Регистрация пользователя

* **Method/URL:** `POST /register`
  
*  **URL Params:** *none*

* **Data Params**

  ```
  {
    username: [username],
    password: [password]
  }
  ```

* **Success Response:**
  
  * **Code:** `200 Ok`
  * **Content:** `{ token: [token] }`
  
  *token*: аутентификационный токен пользователя
 
* **Error Response:**

  * **Code:** `403 Forbidden`
  * **Content:** `{ error : "Username already taken" }`

* **Sample Call:**

  *TODO: добавить пример на js*



### 2.3. Получение списка контактов

Список контактов — список объектов, состоящих из идентификатора диалога (см. п. 1.2) и последнего сообщения в диалоге.

Список сортируется по дате последнего сообщения в порядке убывания. В одном ответе приходит не более 25 контактов.

* **Method/URL:** `GET /:auth_token/contacts[/offset/:offset]`

* **URL Params:**

  * *auth_token*: аутентификационный токен пользователя (32 символа base64);
  * *offset*: количество контактов, которые неободимо пропустить с начала

* **Success Response:**
  
  * **Code:** `200 Ok`
  * **Content:**
    ```
    [
      {
        dialog_id: [dialog_id],
        last_message: {
            guid: [guid],
            [sender: [sender]],
            timestamp: [timestamp],
            type: [type],
            content: [content]
        }
      },
      ...<up to 24 more times>...
    ]
    ```
    
    * *dialog_id*: идентификатор диалога (см. п. 1.2);
    * формат объекта сообщения см. п. 1.1. Поле `sender` в нем содержится только если `dialog_id` обозначает конференцию


